name: CI - Build and Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-push-images:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      security-events: write # Needed for SARIF upload
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      # --- Backend Image Process ---
      - name: Build and push backend image
        run: |
          docker build \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-backend/Dockerfile \
            ./application/fm-compta-consulting-backend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}

      - name: Clean up after backend build
        run: |
          docker system prune -af --volumes
          df -h

      # --- Frontend Image Process ---
      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg NEXTAUTH_URL_ARG=https://fm-compta-consulting.local \
            --build-arg NEXTAUTH_SECRET_ARG=Unn5rTxkCkledz9JJ558l19g1FGjJEIkkMw/o2Y0erE= \
            --build-arg NEXT_PUBLIC_API_URL_ARG=https://fm-compta-consulting.local/api \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-frontend/Dockerfile \
            ./application/fm-compta-consulting-frontend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}

      - name: Final cleanup
        run: |
          docker system prune -af --volumes
          df -h

  run-playwright-tests:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd application/fm-compta-consulting-frontend
          npm ci

      - name: Install Playwright browsers
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.browsers
        run: |
          cd application/fm-compta-consulting-frontend
          echo "Installing Playwright browsers to: $PLAYWRIGHT_BROWSERS_PATH"
          npx playwright install chromium
          echo "Installation complete. Verifying..."
          ls -la $PLAYWRIGHT_BROWSERS_PATH || echo "Browser path not found"
          npx playwright install --help | grep -A 2 "browsers"

      - name: Check application accessibility
        id: check_app
        continue-on-error: true
        run: |
          if curl -k -s -o /dev/null -w "%{http_code}" https://fm-compta-consulting.local | grep -q "200\|301\|302"; then
            echo "accessible=true" >> $GITHUB_OUTPUT
          else
            echo "accessible=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Application not accessible at https://fm-compta-consulting.local"
          fi

      - name: Run Playwright tests
        if: steps.check_app.outputs.accessible == 'true'
        env:
          PLAYWRIGHT_BASE_URL: https://fm-compta-consulting.local
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.browsers
        run: |
          cd application/fm-compta-consulting-frontend
          npx playwright test --reporter=list,html --workers=1 --project=chromium

      - name: Skip Playwright tests
        if: steps.check_app.outputs.accessible != 'true'
        run: |
          echo "âš ï¸ Skipping Playwright tests - application not accessible"
          echo "Tests require the application to be deployed and running"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: application/fm-compta-consulting-frontend/playwright-report/
          retention-days: 7

  run-sonarqube-analysis:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 15
    continue-on-error: true
    if: false # Temporarily disabled - requires configuration
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: SonarQube Scan - Frontend
        continue-on-error: true
        env:
          SONAR_HOST_URL: https://sonarqube.local
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "SonarQube scan temporarily disabled"

      - name: SonarQube Scan - Backend
        continue-on-error: true
        env:
          SONAR_HOST_URL: https://sonarqube.local
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "SonarQube scan temporarily disabled"

  run-owasp-zap-scan:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for ZAP to be ready
        run: |
          echo "Waiting for ZAP API to be ready..."
          for i in {1..30}; do
            if curl -k -s https://zap.local/JSON/core/view/version/ | grep -q "version"; then
              echo "ZAP is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: OWASP ZAP Spider Scan
        continue-on-error: true
        run: |
          TARGET_URL="https://fm-compta-consulting.local"

          echo "Starting ZAP Spider scan on ${TARGET_URL}"

          # Start spider scan
          SCAN_ID=$(curl -k -s "https://zap.local/JSON/spider/action/scan/?url=${TARGET_URL}" | jq -r '.scan')
          echo "Spider scan started with ID: ${SCAN_ID}"

          # Wait for spider to complete
          while true; do
            STATUS=$(curl -k -s "https://zap.local/JSON/spider/view/status/?scanId=${SCAN_ID}" | jq -r '.status')
            echo "Spider progress: ${STATUS}%"
            if [ "${STATUS}" = "100" ]; then
              break
            fi
            sleep 5
          done

          echo "âœ… ZAP Spider scan completed"

      - name: OWASP ZAP Active Scan
        continue-on-error: true
        run: |
          TARGET_URL="https://fm-compta-consulting.local"

          echo "Starting ZAP Active scan on ${TARGET_URL}"

          # Start active scan
          SCAN_ID=$(curl -k -s "https://zap.local/JSON/ascan/action/scan/?url=${TARGET_URL}" | jq -r '.scan')
          echo "Active scan started with ID: ${SCAN_ID}"

          # Wait for active scan to complete (with timeout)
          for i in {1..60}; do
            STATUS=$(curl -k -s "https://zap.local/JSON/ascan/view/status/?scanId=${SCAN_ID}" | jq -r '.status')
            echo "Active scan progress: ${STATUS}%"
            if [ "${STATUS}" = "100" ]; then
              break
            fi
            sleep 10
          done

          echo "âœ… ZAP Active scan completed"

      - name: Generate ZAP HTML Report
        if: always()
        continue-on-error: true
        run: |
          echo "Generating ZAP HTML report..."
          curl -k -s "https://zap.local/OTHER/core/other/htmlreport/" > zap-report.html

          # Get alerts summary
          ALERTS=$(curl -k -s "https://zap.local/JSON/core/view/numberOfAlerts/" | jq -r '.numberOfAlerts')
          echo "ðŸ“Š Total alerts found: ${ALERTS}"

          # Get high risk alerts
          HIGH_ALERTS=$(curl -k -s "https://zap.local/JSON/core/view/alertsSummary/" | jq -r '.alertsSummary[] | select(.risk=="High") | .count' | awk '{s+=$1} END {print s+0}')
          echo "ðŸ”´ High risk alerts: ${HIGH_ALERTS}"

          echo "âœ… ZAP scan report generated: zap-report.html"

  update-manifests:
    needs:
      [
        build-and-push-images,
        run-playwright-tests,
        run-sonarqube-analysis,
        run-owasp-zap-scan,
      ]
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update backend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/backend-deployment.yaml

      - name: Update frontend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/frontend-deployment.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -am "[CI] Deploy new version ${{ github.event.release.tag_name || github.sha }}"
          git push
