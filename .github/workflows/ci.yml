name: CI - Build and Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-push-images:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      security-events: write # Needed for SARIF upload
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      # --- Backend Image Process ---
      - name: Build and push backend image
        run: |
          docker buildx build \
            --load \
            --progress=plain \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-backend/Dockerfile \
            ./application/fm-compta-consulting-backend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}

      - name: Clean up after backend build
        run: |
          docker system prune -af --volumes
          df -h

      # --- Frontend Image Process ---
      - name: Build and push frontend image
        run: |
          docker buildx build \
            --load \
            --progress=plain \
            --build-arg NEXTAUTH_URL_ARG=https://fm-compta-consulting.local \
            --build-arg NEXTAUTH_SECRET_ARG=Unn5rTxkCkledz9JJ558l19g1FGjJEIkkMw/o2Y0erE= \
            --build-arg NEXT_PUBLIC_API_URL_ARG=https://fm-compta-consulting.local/api \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-frontend/Dockerfile \
            ./application/fm-compta-consulting-frontend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}

      - name: Final cleanup
        run: |
          docker system prune -af --volumes
          df -h

  run-playwright-tests:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          cd application/fm-compta-consulting-frontend
          npm ci

      - name: Install Playwright browsers
        run: |
          cd application/fm-compta-consulting-frontend
          npx playwright install chromium --with-deps

      - name: Run Playwright tests
        env:
          PLAYWRIGHT_BASE_URL: https://fm-compta-consulting.local
          HOME: /tmp
        run: |
          cd application/fm-compta-consulting-frontend
          npx playwright test --reporter=list,allure-playwright --workers=1 --project=chromium

      - name: Generate Allure report
        if: always()
        run: |
          cd application/fm-compta-consulting-frontend

          # Install Allure commandline
          curl -o allure-2.24.0.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          tar -zxvf allure-2.24.0.tgz -C /tmp/

          # Generate report
          if [ -d "allure-results" ]; then
            /tmp/allure-2.24.0/bin/allure generate allure-results --clean -o allure-report
            echo "Allure report generated successfully"
          else
            echo "No allure-results found"
          fi

      - name: Upload Allure results to Allure service
        if: always()
        run: |
          cd application/fm-compta-consulting-frontend
          if [ -d "allure-results" ]; then
            # Send results to Allure Docker Service API
            PROJECT_ID="fm-compta-frontend"

            # Create project if not exists
            curl -k -X POST "https://allure.local/allure-docker-service/projects" \
              -H "Content-Type: application/json" \
              -d "{\"id\": \"${PROJECT_ID}\"}" || true

            # Upload results
            cd allure-results
            for file in *; do
              if [ -f "$file" ]; then
                RESULT_FILE=$(cat "$file" | base64 -w 0 || cat "$file" | base64)
                curl -k -X POST "https://allure.local/allure-docker-service/send-results?project_id=${PROJECT_ID}" \
                  -H "Content-Type: application/json" \
                  -d "[{\"file_name\": \"$file\", \"content_base64\": \"${RESULT_FILE}\"}]"
              fi
            done

            # Generate report
            curl -k -X GET "https://allure.local/allure-docker-service/generate-report?project_id=${PROJECT_ID}&execution_name=build-${GITHUB_SHA}&execution_from=ci&execution_type=github-actions"

            echo "âœ… Allure report generated: https://allure.local/allure-docker-service/projects/${PROJECT_ID}/reports/latest"
          fi

  run-sonarqube-analysis:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: SonarQube Scan - Frontend
        continue-on-error: true
        env:
          SONAR_HOST_URL: https://sonarqube.local
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd application/fm-compta-consulting-frontend
          npm ci

          # Download SonarScanner
          curl -o sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner.zip

          # Run analysis
          sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=fm-compta-consulting-frontend \
            -Dsonar.sources=src \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: SonarQube Scan - Backend
        continue-on-error: true
        env:
          SONAR_HOST_URL: https://sonarqube.local
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd application/fm-compta-consulting-backend

          # Download SonarScanner
          curl -o sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -q sonar-scanner.zip

          # Run analysis
          sonar-scanner-5.0.1.3006-linux/bin/sonar-scanner \
            -Dsonar.projectKey=fm-compta-consulting-backend \
            -Dsonar.sources=src \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN

  run-owasp-zap-scan:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for ZAP to be ready
        run: |
          echo "Waiting for ZAP API to be ready..."
          for i in {1..30}; do
            if curl -k -s https://zap.local/JSON/core/view/version/ | grep -q "version"; then
              echo "ZAP is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: OWASP ZAP Spider Scan
        continue-on-error: true
        run: |
          TARGET_URL="https://fm-compta-consulting.local"

          echo "Starting ZAP Spider scan on ${TARGET_URL}"

          # Start spider scan
          SCAN_ID=$(curl -k -s "https://zap.local/JSON/spider/action/scan/?url=${TARGET_URL}" | jq -r '.scan')
          echo "Spider scan started with ID: ${SCAN_ID}"

          # Wait for spider to complete
          while true; do
            STATUS=$(curl -k -s "https://zap.local/JSON/spider/view/status/?scanId=${SCAN_ID}" | jq -r '.status')
            echo "Spider progress: ${STATUS}%"
            if [ "${STATUS}" = "100" ]; then
              break
            fi
            sleep 5
          done

          echo "âœ… ZAP Spider scan completed"

      - name: OWASP ZAP Active Scan
        continue-on-error: true
        run: |
          TARGET_URL="https://fm-compta-consulting.local"

          echo "Starting ZAP Active scan on ${TARGET_URL}"

          # Start active scan
          SCAN_ID=$(curl -k -s "https://zap.local/JSON/ascan/action/scan/?url=${TARGET_URL}" | jq -r '.scan')
          echo "Active scan started with ID: ${SCAN_ID}"

          # Wait for active scan to complete (with timeout)
          for i in {1..60}; do
            STATUS=$(curl -k -s "https://zap.local/JSON/ascan/view/status/?scanId=${SCAN_ID}" | jq -r '.status')
            echo "Active scan progress: ${STATUS}%"
            if [ "${STATUS}" = "100" ]; then
              break
            fi
            sleep 10
          done

          echo "âœ… ZAP Active scan completed"

      - name: Generate ZAP HTML Report
        if: always()
        continue-on-error: true
        run: |
          echo "Generating ZAP HTML report..."
          curl -k -s "https://zap.local/OTHER/core/other/htmlreport/" > zap-report.html

          # Get alerts summary
          ALERTS=$(curl -k -s "https://zap.local/JSON/core/view/numberOfAlerts/" | jq -r '.numberOfAlerts')
          echo "ðŸ“Š Total alerts found: ${ALERTS}"

          # Get high risk alerts
          HIGH_ALERTS=$(curl -k -s "https://zap.local/JSON/core/view/alertsSummary/" | jq -r '.alertsSummary[] | select(.risk=="High") | .count' | awk '{s+=$1} END {print s+0}')
          echo "ðŸ”´ High risk alerts: ${HIGH_ALERTS}"

          echo "âœ… ZAP scan report generated: zap-report.html"

  update-manifests:
    needs:
      [
        build-and-push-images,
        run-playwright-tests,
        run-sonarqube-analysis,
        run-owasp-zap-scan,
      ]
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update backend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/backend-deployment.yaml

      - name: Update frontend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/frontend-deployment.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -am "[CI] Deploy new version ${{ github.event.release.tag_name || github.sha }}"
          git push
