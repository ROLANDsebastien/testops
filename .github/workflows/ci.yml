name: CI - Build and Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-and-push-images:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Build and push backend image
        run: |
          docker build \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-backend/Dockerfile \
            ./application/fm-compta-consulting-backend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}

      - name: Clean up after backend build
        run: |
          docker system prune -af --volumes
          df -h

      - name: Build and push frontend image
        run: |
          docker build \
            --build-arg NEXTAUTH_URL_ARG=https://fm-compta-consulting.local \
            --build-arg NEXTAUTH_SECRET_ARG=Unn5rTxkCkledz9JJ558l19g1FGjJEIkkMw/o2Y0erE= \
            --build-arg NEXT_PUBLIC_API_URL_ARG=https://fm-compta-consulting.local/api \
            -t ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }} \
            -f ./application/fm-compta-consulting-frontend/Dockerfile \
            ./application/fm-compta-consulting-frontend

          docker push ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}

      - name: Final cleanup
        run: |
          docker system prune -af --volumes
          df -h

  run-playwright-tests:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd application/fm-compta-consulting-frontend
          npm ci

      - name: Install Playwright browsers
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.browsers
        run: |
          cd application/fm-compta-consulting-frontend
          echo "Installing Playwright browsers to: $PLAYWRIGHT_BROWSERS_PATH"
          npx playwright install chromium
          echo "Installation complete. Verifying..."
          ls -la $PLAYWRIGHT_BROWSERS_PATH || echo "Browser path not found"
          npx playwright install --help | grep -A 2 "browsers"

      - name: Run Playwright tests
        continue-on-error: true
        env:
          PLAYWRIGHT_BASE_URL: https://fm-compta-consulting.local
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/.browsers
        run: |
          cd application/fm-compta-consulting-frontend
          bash scripts/run-tests-ci.sh || echo "Tests completed with exit code: $?"

          mkdir -p playwright-report allure-results test-results

          if [ ! -f playwright-report/index.html ]; then
            echo "Creating placeholder report..."
            cat > playwright-report/index.html << 'EOFHTML'
          <!DOCTYPE html>
          <html><head><title>Playwright Report</title></head>
          <body><h1>Tests Executed - See Allure Dashboard for Results</h1>
          <p>Playwright tests ran. Check Allure Dashboard at https://allure.local for detailed results.</p>
          </body></html>
          EOFHTML
          fi

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: application/fm-compta-consulting-frontend/playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Allure results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: application/fm-compta-consulting-frontend/allure-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: application/fm-compta-consulting-frontend/test-results/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload results to Allure Dashboard
        if: always()
        continue-on-error: true
        run: |
          cd application/fm-compta-consulting-frontend

          if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
            echo "ðŸ“¤ Uploading results to Allure Dashboard..."
            chmod +x scripts/upload-allure-results.sh
            
            # Use the Ingress URL which is accessible from the runner
            ALLURE_SERVER_URL=https://allure.local \
            ALLURE_PROJECT_ID=fm-compta-consulting \
            bash scripts/upload-allure-results.sh
          else
            echo "âš ï¸ No allure results to upload"
          fi

  run-sonarqube-analysis:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    env:
      SONAR_HOST_URL: https://sonarqube.local
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java for SonarQube
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Node.js for SonarQube
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        run: |
          cd application/fm-compta-consulting-frontend
          npm ci

      - name: Install backend dependencies
        run: |
          cd application/fm-compta-consulting-backend
          npm ci

      - name: Download Playwright Test Results
        uses: actions/download-artifact@v4
        with:
          name: playwright-test-results
          path: application/fm-compta-consulting-frontend/test-results

      - name: Install Sonar Scanner
        run: npm install -g sonarqube-scanner

      - name: SonarQube Scan - Frontend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarqube.local
        run: |
          cd application/fm-compta-consulting-frontend
          sonar-scanner \
            -Dsonar.projectKey=fm-compta-consulting-frontend \
            -Dsonar.sources=src \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

      - name: SonarQube Scan - Backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarqube.local
        run: |
          cd application/fm-compta-consulting-backend
          sonar-scanner \
            -Dsonar.projectKey=fm-compta-consulting-backend \
            -Dsonar.sources=src \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

  run-owasp-zap-scan:
    needs: build-and-push-images
    runs-on: self-hosted
    timeout-minutes: 20
    continue-on-error: true
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for ZAP to be ready
        run: |
          echo "Waiting for ZAP API to be ready..."
          for i in {1..30}; do
            if curl -k -s https://zap.local/JSON/core/view/version/ | grep -q "version"; then
              echo "ZAP is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: OWASP ZAP Quick Baseline Scan
        continue-on-error: true
        run: |
          TARGET_URL="https://fm-compta-consulting.local"
          echo "ðŸ” Starting ZAP Quick Baseline Scan on ${TARGET_URL}"

          echo "Starting quick spider scan..."
          SPIDER_SCAN_ID=$(curl -k -s "https://zap.local/JSON/spider/action/scan/?url=${TARGET_URL}&maxChildren=10&recurse=true&subtreeOnly=true" | jq -r '.scan')
          echo "Spider scan ID: ${SPIDER_SCAN_ID}"

          SPIDER_TIMEOUT=180
          SPIDER_ELAPSED=0
          while [ $SPIDER_ELAPSED -lt $SPIDER_TIMEOUT ]; do
            STATUS=$(curl -k -s "https://zap.local/JSON/spider/view/status/?scanId=${SPIDER_SCAN_ID}" | jq -r '.status')
            echo "Spider progress: ${STATUS}%"
            if [ "${STATUS}" = "100" ]; then
              echo "âœ… Spider scan completed"
              break
            fi
            sleep 5
            SPIDER_ELAPSED=$((SPIDER_ELAPSED + 5))
          done

          echo "Running passive scan analysis..."
          URLS_FOUND=$(curl -k -s "https://zap.local/JSON/core/view/numberOfMessages/" | jq -r '.numberOfMessages')
          echo "ðŸ“Š URLs analyzed: ${URLS_FOUND}"

          echo "â© Skipping active scan for speed (baseline scan only)"
          echo "âœ… ZAP baseline scan completed"

      - name: Generate ZAP Report
        if: always()
        continue-on-error: true
        run: |
          echo "ðŸ“„ Generating ZAP security report..."

          curl -k -s "https://zap.local/OTHER/core/other/htmlreport/" > zap-report.html

          ALERTS=$(curl -k -s "https://zap.local/JSON/core/view/numberOfAlerts/" | jq -r '.numberOfAlerts // 0')
          echo "ðŸ“Š Total alerts: ${ALERTS}"

          ALERTS_SUMMARY=$(curl -k -s "https://zap.local/JSON/core/view/alertsSummary/")
          HIGH=$(echo "$ALERTS_SUMMARY" | jq -r '[.alertsSummary[] | select(.risk=="High")] | length // 0')
          MEDIUM=$(echo "$ALERTS_SUMMARY" | jq -r '[.alertsSummary[] | select(.risk=="Medium")] | length // 0')
          LOW=$(echo "$ALERTS_SUMMARY" | jq -r '[.alertsSummary[] | select(.risk=="Low")] | length // 0')

          echo "ðŸ”´ High risk: ${HIGH}"
          echo "ðŸŸ  Medium risk: ${MEDIUM}"
          echo "ðŸŸ¡ Low risk: ${LOW}"
          echo "âœ… ZAP report generated"

      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap-report.html
          retention-days: 30
          if-no-files-found: ignore

      - name: Publish ZAP results to Allure Dashboard
        if: always()
        continue-on-error: true
        run: |
          chmod +x \
            devops/owasp/generate-zap-allure-results.sh \
            application/fm-compta-consulting-frontend/scripts/upload-allure-results.sh

          RESULT_DIR=$(mktemp -d)
          SCAN_TARGET=https://fm-compta-consulting.local \
          ZAP_REPORT_FILE="$GITHUB_WORKSPACE/zap-report.html" \
          ALLURE_RESULTS_DIR="$RESULT_DIR" \
          bash devops/owasp/generate-zap-allure-results.sh

          ALLURE_SERVER_URL=https://allure.local \
          ALLURE_PROJECT_ID=owasp-zap \
          ALLURE_RESULTS_DIR="$RESULT_DIR" \
          bash application/fm-compta-consulting-frontend/scripts/upload-allure-results.sh

  update-manifests:
    needs:
      [
        build-and-push-images,
        run-playwright-tests,
        run-sonarqube-analysis,
        run-owasp-zap-scan,
      ]
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update backend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-backend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/backend-deployment.yaml

      - name: Update frontend image tag
        run: |
          sed -i "s|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:.*|image: ghcr.io/rolandsebastien/fm-compta-consulting-frontend:${{ github.event.release.tag_name || github.sha }}|" application/manifests/frontend-deployment.yaml

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -am "[CI] Deploy new version ${{ github.event.release.tag_name || github.sha }}"
          git push
